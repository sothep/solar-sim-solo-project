var app=angular.module("SolarApp",["ngRoute","ngCookies","ngAnimate","trNgGrid"]),MAX_INSTALLS_PERMITTED=10,DEG_SYMBOL="Â°";app.config(["$routeProvider","$locationProvider",function(a,b){a.when("/login",{templateUrl:"views/login.html",controller:"LoginController"}).when("/register",{templateUrl:"views/register.html",controller:"RegisterController"}).when("/",{templateUrl:"views/home.html",controller:"HomeController"}).when("/create",{templateUrl:"views/create.html",controller:"CreateController",resolve:{numInstallResponse:["$http","SolarService",function(a,b){return b.numInstalls()}]}}).when("/view",{templateUrl:"views/view.html",controller:"ViewController"}).otherwise({templateUrl:"views/login.html",controller:"LoginController"}),b.html5Mode(!0)}]),app.controller("MainController",["$scope","$location","$interval","AuthentiService","SolarService",function(a,b,c,d,e){this.username="",this.loggedIn=function(){return this.username=d.getName(),d.loggedIn()};var f=function(){d.signOut().then(function(a){b.path("/login")})};this.signOut=f;var g=function(){d.serverLoggedIn().then(function(a){if(console.log("checking login status with server..."),"failure"==a.data){if("/register"===b.path().toString()||"/login"===b.path().toString())return;f()}})};this.isNavButtonActive=function(a){return b.path().toString()===a?"active":!1},c(g,3e4)}]),app.controller("LoginController",["$scope","$location","AuthentiService",function(a,b,c){a.pageClass="short",a.user={username:"",password:""},a.badLogin=!1,a.resetFlags=function(){a.badLogin=!1},a.login=function(){a.resetFlags(),c.signIn(a.user).then(function(d){"success"==d.data?(c.logIn(a.user.username),b.path("/")):a.badLogin=!0},function(a){return console.log("Error: authentication failed."),!1})}}]),app.controller("RegisterController",["$scope","$location","AuthentiService",function(a,b,c){a.pageClass="short",a.userExists=!1,a.badLogin=!1,a.user={username:"",password:""},a.passwordConfirm="";var d=function(){a.passwordUnmatched=!1,a.userExists=!1,a.badLogin=!1};a.register=function(){return d(),console.log("hello?"),a.user.password!=a.passwordConfirm?void(a.passwordUnmatched=!0):void c.register(a.user).then(function(d){"success"==d.data?c.signIn(a.user).then(function(d){"success"==d.data?(c.logIn(a.user.username),b.path("/")):a.badLogin=!0},function(a){return console.log("Error: authentication failed."),!1}):a.userExists=!0})}}]),app.controller("HomeController",["$scope","$location","AuthentiService",function(a,b,c){c.loggedIn()||b.path("/login"),a.pageClass="short"}]),app.controller("WarningController",["$scope","$location","AuthentiService",function(a,b,c){c.loggedIn()||b.path("/login")}]),app.controller("ViewController",["$scope","$location","$filter","AuthentiService","SolarService",function(a,b,c,d,e){function f(a){switch(a){case 0:return"Jan";case 1:return"Feb";case 2:return"Mar";case 3:return"Apr";case 4:return"May";case 5:return"Jun";case 6:return"Jul";case 7:return"Aug";case 8:return"Sep";case 9:return"Oct";case 10:return"Nov";case 11:return"Dec"}}d.loggedIn()||b.path("/login"),a.installData=[],a.tableData=[],a.tableIds=[],a.selectedInstall=null,a.error=null,a.formData={noInstalls:!1};var g=function(){a.formData.noInstalls=!1};a.getInstalls=function(){g(),e.getInstalls().then(function(b){b.data&&b.data.installs?(a.installData=b.data.installs,h()):a.error="Error connecting to PVWatts5 API.  Please try again later.",0==a.installData.length&&(console.log("no installs..."),a.formData.noInstalls=!0)})};var h=function(){a.tableData=[];for(var b=0;b<a.installData.length;b++){var d=a.installData[b];a.tableData.push({id:d._id,Name:d.name,Created:c("date")(d.created,"MM/dd/yy"),Location:p(d.location["long"],d.location.lat),Orientation:q(d.orientation.tilt,d.orientation.azimuth),Power:d.panel.capacity+" kW",Losses:d.panel.losses+"%",Placement:r(d.panel.array_type),Panel:s(d.panel.module_type),AC_monthly_kWh:d.ac_monthly})}o()},i=600,j=360,k=50,l=[],m=[],n=d3.scale.category10(),o=function(){l=[];for(var b=0;b<a.tableData.length;b++){l.push([]);for(var c=0;c<a.tableData[b].AC_monthly_kWh.length;c++)l[l.length-1].push({x:c,y:a.tableData[b].AC_monthly_kWh[c]});m.push({name:a.tableData[b].Name,color:n(b)})}console.log("gData:",l),console.log("legendInfo:",m);var d=d3.extent(d3.merge(l),function(a){return a.y}),e=d3.extent(d3.merge(l),function(a){return a.x});d[0]=0;var g=d3.scale.linear().domain([e[0],e[1]]).range([k,i-2*k]),h=d3.scale.linear().domain([d[0],d[1]]).range([j-k,k]);d3.select("svg").remove();var o=d3.select(".chartArea").append("svg").attr("width",i).attr("height",j).attr("opacity","0"),p=d3.svg.axis().scale(g).orient("bottom").ticks(12).tickFormat(function(a){return f(a)}),q=d3.svg.axis().scale(h).orient("left").ticks(8);o.append("g").attr("class","axis").attr("transform","translate(0,"+(j-k)+")").call(p),o.append("g").attr("class","axis").attr("transform","translate("+k+",0)").call(q);var r=o.selectAll("g.line").data(l);r.enter().append("g").attr("class","line").attr("style",function(a){return"stroke: "+n(l.indexOf(a))}),r.selectAll("path").data(function(a){return[a]}).enter().append("path").attr("d",d3.svg.line().x(function(a){return g(a.x)}).y(function(a){return h(a.y)}));o.append("g").attr("class","legend").attr("height",200).attr("width",250);o.transition().delay(300).duration(1e3).attr("opacity","1")},p=function(a,b){var c,d,e=a.toFixed(0),f=b.toFixed(0);return a>0?d="E":(d="W",e/=-1),b>0?c="N":(c="S",f/=-1),f+DEG_SYMBOL+" "+c+", "+e+DEG_SYMBOL+" "+d},q=function(a,b){return a+DEG_SYMBOL+" tilt, "+b+DEG_SYMBOL+"az."},r=function(a){switch(a){case 1:return"Roof-Mounted";case 4:return"2-Axis Tracking";default:return"Open Rack"}},s=function(a){switch(a){case 0:return"Standard";case 1:return"Premium";default:return"Thin Film"}};a.deleteInstall=function(b){e.deleteInstall(b).then(function(b){a.getInstalls()})},a.getInstalls()}]),app.controller("CreateController",["$scope","$location","numInstallResponse","AuthentiService","SolarService",function(a,b,c,d,e){d.loggedIn()||b.path("/login");var f=c.data.count,g=function(){return f>=MAX_INSTALLS_PERMITTED?!0:!1};a.formInfo={numRemaining:MAX_INSTALLS_PERMITTED-f,disableForm:g()},a.error=null,a.dupName=!1,a.installData={name:"",latitude:40,longitude:-105,tilt:40,azimuth:180,capacityKW:4,percentLosses:14,arrayType:1,moduleType:0},a.resetFlags=function(){a.error=null,a.dupName=!1},a.newSolarInstall=function(){a.resetFlags(),e.getInstalls().then(function(c){if(c.data&&c.data.installs)for(var d=0;d<c.data.installs.length;d++)if(c.data.installs[d].name==a.installData.name)return void(a.dupName=!0);e.newInstall(a.installData).then(function(c){"success"==c.data?b.path("/view"):a.error=!0})})}}]),app.factory("SolarService",["$http",function(a){var b=function(b){return a.post("/pvwatts5/new",b)},c=function(){return a.get("/pvwatts5/userInstalls")},d=function(b){return a["delete"]("/pvwatts5/install/"+b)},e=function(){return a.get("/pvwatts5/numInstalls")};return{newInstall:b,getInstalls:c,deleteInstall:d,numInstalls:e}}]),app.factory("AuthentiService",["$http","$cookies",function(a,b){var c=!1,d=function(){return c=!1,b.put("loggedIn",""),b.put("user",""),a.get("/signout")},e=function(b){d();var c=b.username+"/"+b.password;return a.post("/auth/register/"+c)},f=function(b){return d(),a.post("/",b)},g=function(a){c=!0,b.put("loggedIn","true"),b.put("username",a)},h=function(){return c||"true"==b.get("loggedIn")?!0:!1},i=function(){return a.get("/loggedIn")},j=function(){var a=b.get("username");return a&&a.length>0?a:null};return{register:e,signIn:f,signOut:d,logIn:g,loggedIn:h,serverLoggedIn:i,getName:j}}]);