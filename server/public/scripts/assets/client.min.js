var app=angular.module("SolarApp",["ngRoute","ngCookies"]),MAX_INSTALLS_PERMITTED=5;app.config(["$routeProvider","$locationProvider",function(a,b){a.when("/login",{templateUrl:"views/login.html",controller:"LoginController"}).when("/register",{templateUrl:"views/register.html",controller:"RegisterController"}).when("/",{templateUrl:"views/home.html",controller:"HomeController"}).when("/create",{templateUrl:"views/create.html",controller:"CreateController"}).when("/view",{templateUrl:"views/view.html",controller:"ViewController"}).otherwise({templateUrl:"views/login.html",controller:"LoginController"}),b.html5Mode(!0)}]),app.controller("MainController",["$scope","$location","$interval","AuthentiService","SolarService",function(a,b,c,d,e){this.username="",this.loggedIn=function(){return this.username=d.getName(),d.loggedIn()},this.preventCreate=!1;var f=function(){d.signOut().then(function(a){b.path("/login")})};this.signOut=f;var g=function(){d.serverLoggedIn().then(function(a){console.log("checking login status with server..."),"failure"==a.data&&f()})};c(g,3e4)}]),app.controller("LoginController",["$scope","$location","AuthentiService",function(a,b,c){a.user={username:"",password:""},a.badLogin=!1,a.resetFlags=function(){a.badLogin=!1},a.register=function(){b.path("/register")},a.login=function(){a.resetFlags(),c.signIn(a.user).then(function(d){"success"==d.data?(c.logIn(a.user.username),b.path("/")):a.badLogin=!0},function(a){return console.log("Error: authentication failed."),!1})}}]),app.controller("RegisterController",["$scope","$location","AuthentiService",function(a,b,c){a.userExists=!1,a.badLogin=!1,a.user={username:"",password:""},a.passwordConfirm="";var d=function(){a.passwordUnmatched=!1,a.userExists=!1,a.badLogin=!1};a.register=function(){return d(),a.user.password!=a.passwordConfirm?void(a.passwordUnmatched=!0):void c.register(a.user).then(function(d){"success"==d.data?c.signIn(a.user).then(function(d){"success"==d.data?(c.logIn(a.user.username),b.path("/")):a.badLogin=!0},function(a){return console.log("Error: authentication failed."),!1}):a.userExists=!0})}}]),app.controller("HomeController",["$scope","$location","AuthentiService",function(a,b,c){c.loggedIn()||b.path("/login")}]),app.controller("ViewController",["$scope","$location","AuthentiService","SolarService",function(a,b,c,d){c.loggedIn()||b.path("/login"),a.installData=[],a.selectedInstall=null,a.error=null,a.getInstalls=function(){d.getInstalls().then(function(b){b.data&&b.data.installs?a.installData=b.data.installs:a.error="Error connecting to PVWatts5 API.  Please try again later."})},a.deleteInstall=function(b){d.deleteInstall(b).then(function(b){a.getInstalls()})},a.getInstalls()}]),app.controller("CreateController",["$scope","$location","AuthentiService","SolarService",function(a,b,c,d){c.loggedIn()||b.path("/login"),a.error=null,a.dupName=!1,a.suggestedTilt="",a.suggestedAzi="",a.installData={name:"",latitude:40,longitude:-105,tilt:40,azimuth:180,capacityKW:4,percentLosses:14,arrayType:0,moduleType:0},a.resetFlags=function(){a.error=null,a.dupName=!1},a.newSolarInstall=function(){a.resetFlags(),d.getInstalls().then(function(c){if(c.data&&c.data.installs)for(var e=0;e<c.data.installs.length;e++)if(c.data.installs[e].name==a.installData.name)return void(a.dupName=!0);d.newInstall(a.installData).then(function(c){"success"==c.data?b.path("/view"):a.error="Error connecting to PVWatts5 API.  Please try again later."})})}}]),app.factory("SolarService",["$http",function(a){var b=function(b){return a.post("/pvwatts5/new",b)},c=function(){return a.get("/pvwatts5/userInstalls")},d=function(b){return a["delete"]("/pvwatts5/install/"+b)},e=function(){return a.get("/pvwatts5/numInstalls")};return{newInstall:b,getInstalls:c,deleteInstall:d,numInstalls:e}}]),app.factory("AuthentiService",["$http","$cookies",function(a,b){var c=!1,d=function(){return c=!1,b.put("loggedIn",""),b.put("user",""),a.get("/signout")},e=function(b){d();var c=b.username+"/"+b.password;return a.post("/auth/register/"+c)},f=function(b){return d(),a.post("/",b)},g=function(a){c=!0,b.put("loggedIn","true"),b.put("username",a)},h=function(){return c||"true"==b.get("loggedIn")?!0:!1},i=function(){return a.get("/loggedIn")},j=function(){var a=b.get("username");return a&&a.length>0?a:null};return{register:e,signIn:f,signOut:d,logIn:g,loggedIn:h,serverLoggedIn:i,getName:j}}]);